USE MDM_CM; DECLARE @varClose INT,  @recordsClose INT = 500; BEGIN  SELECT @varClose = Count(1)  FROM mdm_custom..TEMP_ORG_NUMBER_UPDATE  WHERE flag = '0';  IF ( @varClose > 1 )  BEGIN  UPDATE TOP(@recordsClose) mdm_custom..TEMP_ORG_NUMBER_UPDATE  SET flag = 1  WHERE PKEY_SRC_OBJECT in (select TOP(500) PKEY_SRC_OBJECT from mdm_custom..TEMP_ORG_NUMBER_UPDATE where flag='0');   PRINT( 'updated flag 0 to 1' )  DELETE FROM MDM_CM..C_S_MDM_ORGNO_MPNG_VT;   PRINT( 'delete the stage table' )  INSERT INTO  MDM_CM..C_S_MDM_ORGNO_MPNG_VT (PKEY_SRC_OBJECT,SRC_ROWID,VERSION_SEQ,LAST_UPDATE_DATE,ROWID_OBJECT,ORGANIZATION_NUMBER)  select s.PKEY_SRC_OBJECT,s.SRC_ROWID,s.VERSION_SEQ,s.LAST_UPDATE_DATE,s.ROWID_OBJECT,s.ORGANIZATION_NUMBER from mdm_custom..TEMP_ORG_NUMBER_UPDATE s where exists ( select 1 from mdm_custom..TEMP_ORG_NUMBER_UPDATE where s.PKEY_SRC_OBJECT in(select  PKEY_SRC_OBJECT from mdm_custom..TEMP_ORG_NUMBER_UPDATE where flag=1) );  PRINT( 'inserted the stage table' )  UPDATE mdm_custom..TEMP_ORG_NUMBER_UPDATE  SET flag = 2 WHERE flag = 1 ; PRINT( 'updated flag 1 to 2' )   END  END 